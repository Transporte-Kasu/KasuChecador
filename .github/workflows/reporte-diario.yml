name: Reporte Diario de Asistencia

on:
  schedule:
    # Ejecutar todos los días a las 12:05 PM (Mexico City time = UTC -6)
    # Nota: GitHub Actions usa UTC, así que usamos 18:05 UTC
    - cron: '5 18 * * *'
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  send-daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run daily report command
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DEBUG: 'False'
          ALLOWED_HOSTS: '.ondigitalocean.app,localhost'
          USERNAME: ${{ secrets.DB_USERNAME }}
          PASSWORD: ${{ secrets.DB_PASSWORD }}
          HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DATABASE: ${{ secrets.DB_NAME }}
          SSLMODE: 'REQUIRED'
          EMAIL_HOST_PASSWORD: ${{ secrets.SENDGRID_API_KEY }}
          CSRF_TRUSTED_ORIGINS: 'https://*.ondigitalocean.app'
        run: |
          python manage.py enviar_reporte_dario

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Error al generar reporte diario')
